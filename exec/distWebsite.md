# Mailat 포팅메뉴얼
---

## Distribute Website

### 1. EC2 인스턴스 준비 및 SSH 접속

1.  **EC2 인스턴스 생성**:
    *   OS: Ubuntu 22.04 LTS
    *   인스턴스 유형: t2.micro (또는 필요에 따른 사양)
    *   보안 그룹 설정:
        *   SSH (포트 22): 내 IP에서만 허용
        *   HTTP (포트 80): 전체 허용 (0.0.0.0/0, ::/0)
        *   HTTPS (포트 443): 전체 허용 (0.0.0.0/0, ::/0)
        *   Custom TCP (포트 5000): API 서버용 (필요시, 전체 또는 특정 IP 허용)
    *   EC2 인스턴스의 **퍼블릭 IP 주소**를 확인합니다.

2.  **SSH 접속**:
    *   MobaXterm 또는 다른 SSH 클라이언트를 사용하여 EC2 인스턴스에 접속합니다.
    *   사용자 이름은 `ubuntu`를 사용하고, EC2 생성 시 사용한 `.pem` 키 파일을 인증에 사용합니다.

### 2. Nginx 설치 및 기본 설정

1.  **패키지 목록 업데이트 및 Nginx 설치**:
    ```bash
    sudo apt update
    sudo apt install nginx -y
    ```

2.  **Nginx 서비스 상태 확인**:
    설치가 완료되면 Nginx는 자동으로 시작됩니다. 상태를 확인합니다.
    ```bash
    sudo systemctl status nginx
    ```
    `Active: active (running)` 메시지가 표시되는지 확인합니다.

3.  **방화벽 설정 (UFW 사용 시)**:
    UFW(Uncomplicated Firewall)를 사용 중이라면 Nginx에 대한 접근을 허용합니다.
    ```bash
    sudo ufw allow 'Nginx Full' # HTTP 및 HTTPS 허용
    sudo ufw enable # UFW 활성화 (이미 활성화된 경우 생략)
    sudo ufw status
    ```

### 3. 웹사이트 파일 준비 및 Nginx 구성

1.  **웹사이트 파일 업로드 디렉터리 생성**:
    `ubuntu` 사용자의 홈 디렉터리 아래에 웹사이트 파일을 저장할 `workspace` 디렉터리를 생성합니다.
    ```bash
    mkdir ~/workspace
    ```

2.  **로컬 웹사이트 파일 EC2로 전송**:
    로컬 머신의 `c:\S12P31A204\apps\web-site` 디렉터리 내용을 EC2 인스턴스의 `~/workspace` 디렉터리로 복사합니다. SCP를 사용하는 예시는 다음과 같습니다 (로컬 터미널에서 실행).
    ```bash
    # 예시: 로컬의 web-site 폴더 내용을 EC2 인스턴스의 /home/ubuntu/workspace/ 로 복사
    # scp -i /path/to/your-key.pem -r c:\S12P31A204\apps\web-site\* ubuntu@your-ec2-public-ip:/home/ubuntu/workspace/
    ```
    *   `/path/to/your-key.pem`을 실제 pem 키 경로로 변경하십시오.
    *   `your-ec2-public-ip`를 실제 EC2 인스턴스의 퍼블릭 IP 주소로 변경하십시오.
    *   Windows의 `scp` 사용이 익숙하지 않다면, FileZilla와 같은 SFTP 클라이언트를 사용하여 `apps/web-site` 폴더 안의 모든 파일과 폴더를 `/home/ubuntu/workspace/`로 업로드할 수 있습니다.

3.  **Nginx 설정 파일 수정**:
    Nginx의 기본 사이트 설정 파일을 수정하여 웹사이트 루트 디렉터리를 변경합니다.
    ```bash
    sudo vi /etc/nginx/sites-available/default
    ```
    파일 내용에서 `root` 지시어를 찾아 다음과 같이 수정합니다.

    ```nginx
    // filepath: /etc/nginx/sites-available/default
    // ...existing code...
    server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /home/ubuntu/workspace; # 기존 /var/www/html 에서 변경

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;

        server_name _; # 또는 your-domain.com (도메인 연결 후)

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }
    // ...existing code...
    }
    ```
    `root /var/www/html;` 라인을 `root /home/ubuntu/workspace;`로 변경합니다.

4.  **Nginx 설정 테스트 및 재시작**:
    ```bash
    sudo nginx -t # 설정 파일 문법 검사
    sudo systemctl restart nginx
    ```

5.  **권한 문제 해결**:
    만약 웹사이트 접속 시 403 Forbidden 오류가 발생하거나, Nginx 오류 로그 (`sudo tail -f /var/log/nginx/error.log`)에 "Permission denied" 관련 메시지가 보인다면, 디렉터리 권한 문제입니다.
    ```bash
    # /home/ubuntu 디렉터리에 실행 권한 부여 (다른 사용자가 접근 가능하도록)
    sudo chmod 755 /home/ubuntu

    # /home/ubuntu/workspace 디렉터리와 그 내용에 읽기 및 실행 권한 부여
    sudo chmod -R 755 /home/ubuntu/workspace

    # (선택적이지만 권장) 웹사이트 파일의 소유자를 Nginx 실행 사용자(www-data)로 변경
    # sudo chown -R www-data:www-data /home/ubuntu/workspace
    ```
    권한 변경 후 Nginx를 다시 재시작합니다.
    ```bash
    sudo systemctl restart nginx
    ```
    이제 EC2 인스턴스의 퍼블릭 IP 주소 (`http://your-ec2-public-ip`)로 접속하여 웹사이트가 정상적으로 표시되는지 확인합니다.

### 4. 도메인 연결 및 HTTPS 설정 (Certbot 사용)

1.  **도메인 준비 및 DNS 설정**:
    *   사용할 도메인(예: `your-domain.com`)을 준비합니다.
    *   도메인 등록기관의 DNS 설정에서 A 레코드를 생성하여 도메인이 EC2 인스턴스의 **퍼블릭 IP 주소**를 가리키도록 설정합니다. DNS 변경 사항이 전파되기까지 시간이 걸릴 수 있습니다.

2.  **Certbot 설치**:
    Certbot은 Let's Encrypt 인증서를 쉽게 발급받고 Nginx에 HTTPS를 자동으로 설정해주는 도구입니다.
    ```bash
    sudo apt install certbot python3-certbot-nginx -y
    ```

3.  **Certbot으로 SSL 인증서 발급 및 Nginx 설정**:
    Nginx 설정 파일(`/etc/nginx/sites-available/default`)의 `server_name` 지시어가 `_` 대신 실제 도메인 이름(예: `server_name your-domain.com www.your-domain.com;`)으로 설정되어 있는지 확인하고, 아니라면 수정 후 Nginx를 재시작합니다.
    ```bash
    sudo vi /etc/nginx/sites-available/default 
    # server_name your-domain.com www.your-domain.com; 로 수정
    sudo systemctl restart nginx 
    ```
    그런 다음 Certbot을 실행합니다.
    ```bash
    sudo certbot --nginx -d your-domain.com -d www.your-domain.com # -d 옵션으로 도메인 지정
    ```
    *   `your-domain.com`을 실제 도메인 이름으로 변경합니다. `www` 서브도메인도 사용한다면 함께 추가합니다.
    *   Certbot이 이메일 주소를 묻고, 서비스 약관 동의를 요청할 것입니다.
    *   HTTP 트래픽을 HTTPS로 리디렉션할지 묻는 옵션이 나오면, 일반적으로 2번(Redirect)을 선택하는 것이 좋습니다.

4.  **Certbot 자동 갱신 확인**:
    Certbot은 인증서 자동 갱신을 위한 cron 작업 또는 systemd 타이머를 설정합니다. 다음 명령으로 테스트할 수 있습니다.
    ```bash
    sudo certbot renew --dry-run
    ```

5.  **HTTPS 접속 확인**:
    웹 브라우저에서 `https://your-domain.com`으로 접속하여 웹사이트가 HTTPS로 안전하게 서비스되는지 확인합니다. HTTP로 접속 시 HTTPS로 자동 리디렉션되는지도 확인합니다.

    **주의**: Let's Encrypt는 특정 도메인에 대해 단기간에 발급할 수 있는 인증서 수에 제한(Rate Limits)이 있습니다. `kro.kr`과 같은 무료 하위 도메인 공유 서비스의 경우 이 제한에 도달하기 쉬우므로, 개인 도메인을 사용하거나 다른 도메인 공급자를 고려하는 것이 좋습니다. 오류 발생 시 메시지를 잘 확인하십시오.

이제 EC2 인스턴스에서 Nginx를 통해 웹사이트가 서비스되며, HTTPS로 안전하게 통신할 수 있게 됩니다.
```<!-- filepath: c:\S12P31A204\exec\distWebsite.md -->
# Mailat 포팅메뉴얼
---

## Distribute Website

이 섹션에서는 `apps/web-site`에 있는 정적 웹사이트를 AWS EC2 Ubuntu 인스턴스에 배포하고 Nginx를 사용하여 서비스하며, Certbot으로 HTTPS를 설정하는 과정을 안내합니다.

### 1. EC2 인스턴스 준비 및 SSH 접속

1.  **EC2 인스턴스 생성**:
    *   OS: Ubuntu 22.04 LTS
    *   인스턴스 유형: t2.micro (또는 필요에 따른 사양)
    *   보안 그룹 설정:
        *   SSH (포트 22): 내 IP에서만 허용
        *   HTTP (포트 80): 전체 허용 (0.0.0.0/0, ::/0)
        *   HTTPS (포트 443): 전체 허용 (0.0.0.0/0, ::/0)
        *   Custom TCP (포트 5000): API 서버용 (필요시, 전체 또는 특정 IP 허용)
    *   EC2 인스턴스의 **퍼블릭 IP 주소**를 확인합니다.

2.  **SSH 접속**:
    *   MobaXterm 또는 다른 SSH 클라이언트를 사용하여 EC2 인스턴스에 접속합니다.
    *   사용자 이름은 `ubuntu`를 사용하고, EC2 생성 시 사용한 `.pem` 키 파일을 인증에 사용합니다.

### 2. Nginx 설치 및 기본 설정

1.  **패키지 목록 업데이트 및 Nginx 설치**:
    ```bash
    sudo apt update
    sudo apt install nginx -y
    ```

2.  **Nginx 서비스 상태 확인**:
    설치가 완료되면 Nginx는 자동으로 시작됩니다. 상태를 확인합니다.
    ```bash
    sudo systemctl status nginx
    ```
    `Active: active (running)` 메시지가 표시되는지 확인합니다.

3.  **방화벽 설정 (UFW 사용 시)**:
    UFW(Uncomplicated Firewall)를 사용 중이라면 Nginx에 대한 접근을 허용합니다.
    ```bash
    sudo ufw allow 'Nginx Full' # HTTP 및 HTTPS 허용
    sudo ufw enable # UFW 활성화 (이미 활성화된 경우 생략)
    sudo ufw status
    ```

### 3. 웹사이트 파일 준비 및 Nginx 구성

1.  **웹사이트 파일 업로드 디렉터리 생성**:
    `ubuntu` 사용자의 홈 디렉터리 아래에 웹사이트 파일을 저장할 `workspace` 디렉터리를 생성합니다.
    ```bash
    mkdir ~/workspace
    ```

2.  **로컬 웹사이트 파일 EC2로 전송**:
    로컬 머신의 `c:\S12P31A204\apps\web-site` 디렉터리 내용을 EC2 인스턴스의 `~/workspace` 디렉터리로 복사합니다. SCP를 사용하는 예시는 다음과 같습니다 (로컬 터미널에서 실행).
    ```bash
    # 예시: 로컬의 web-site 폴더 내용을 EC2 인스턴스의 /home/ubuntu/workspace/ 로 복사
    # scp -i /path/to/your-key.pem -r c:\S12P31A204\apps\web-site\* ubuntu@your-ec2-public-ip:/home/ubuntu/workspace/
    ```
    *   `/path/to/your-key.pem`을 실제 pem 키 경로로 변경하십시오.
    *   `your-ec2-public-ip`를 실제 EC2 인스턴스의 퍼블릭 IP 주소로 변경하십시오.
    *   Windows의 `scp` 사용이 익숙하지 않다면, FileZilla와 같은 SFTP 클라이언트를 사용하여 `apps/web-site` 폴더 안의 모든 파일과 폴더를 `/home/ubuntu/workspace/`로 업로드할 수 있습니다.

3.  **Nginx 설정 파일 수정**:
    Nginx의 기본 사이트 설정 파일을 수정하여 웹사이트 루트 디렉터리를 변경합니다.
    ```bash
    sudo vi /etc/nginx/sites-available/default
    ```
    파일 내용에서 `root` 지시어를 찾아 다음과 같이 수정합니다.

    ```nginx
    // filepath: /etc/nginx/sites-available/default
    // ...existing code...
    server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /home/ubuntu/workspace; # 기존 /var/www/html 에서 변경

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;

        server_name _; # 또는 your-domain.com (도메인 연결 후)

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }
    // ...existing code...
    }
    ```
    `root /var/www/html;` 라인을 `root /home/ubuntu/workspace;`로 변경합니다.

4.  **Nginx 설정 테스트 및 재시작**:
    ```bash
    sudo nginx -t # 설정 파일 문법 검사
    sudo systemctl restart nginx
    ```

5.  **권한 문제 해결**:
    만약 웹사이트 접속 시 403 Forbidden 오류가 발생하거나, Nginx 오류 로그 (`sudo tail -f /var/log/nginx/error.log`)에 "Permission denied" 관련 메시지가 보인다면, 디렉터리 권한 문제입니다.
    ```bash
    # /home/ubuntu 디렉터리에 실행 권한 부여 (다른 사용자가 접근 가능하도록)
    sudo chmod 755 /home/ubuntu

    # /home/ubuntu/workspace 디렉터리와 그 내용에 읽기 및 실행 권한 부여
    sudo chmod -R 755 /home/ubuntu/workspace

    # (선택적이지만 권장) 웹사이트 파일의 소유자를 Nginx 실행 사용자(www-data)로 변경
    # sudo chown -R www-data:www-data /home/ubuntu/workspace
    ```
    권한 변경 후 Nginx를 다시 재시작합니다.
    ```bash
    sudo systemctl restart nginx
    ```
    이제 EC2 인스턴스의 퍼블릭 IP 주소 (`http://your-ec2-public-ip`)로 접속하여 웹사이트가 정상적으로 표시되는지 확인합니다.

### 4. 도메인 연결 및 HTTPS 설정 (Certbot 사용)

1.  **도메인 준비 및 DNS 설정**:
    *   사용할 도메인(예: `your-domain.com`)을 준비합니다.
    *   도메인 등록기관의 DNS 설정에서 A 레코드를 생성하여 도메인이 EC2 인스턴스의 **퍼블릭 IP 주소**를 가리키도록 설정합니다. DNS 변경 사항이 전파되기까지 시간이 걸릴 수 있습니다.

2.  **Certbot 설치**:
    Certbot은 Let's Encrypt 인증서를 쉽게 발급받고 Nginx에 HTTPS를 자동으로 설정해주는 도구입니다.
    ```bash
    sudo apt install certbot python3-certbot-nginx -y
    ```

3.  **Certbot으로 SSL 인증서 발급 및 Nginx 설정**:
    Nginx 설정 파일(`/etc/nginx/sites-available/default`)의 `server_name` 지시어가 `_` 대신 실제 도메인 이름(예: `server_name your-domain.com www.your-domain.com;`)으로 설정되어 있는지 확인하고, 아니라면 수정 후 Nginx를 재시작합니다.
    ```bash
    sudo vi /etc/nginx/sites-available/default 
    # server_name your-domain.com www.your-domain.com; 로 수정
    sudo systemctl restart nginx 
    ```
    그런 다음 Certbot을 실행합니다.
    ```bash
    sudo certbot --nginx -d your-domain.com -d www.your-domain.com # -d 옵션으로 도메인 지정
    ```
    *   `your-domain.com`을 실제 도메인 이름으로 변경합니다. `www` 서브도메인도 사용한다면 함께 추가합니다.
    *   Certbot이 이메일 주소를 묻고, 서비스 약관 동의를 요청할 것입니다.
    *   HTTP 트래픽을 HTTPS로 리디렉션할지 묻는 옵션이 나오면, 일반적으로 2번(Redirect)을 선택하는 것이 좋습니다.

4.  **Certbot 자동 갱신 확인**:
    Certbot은 인증서 자동 갱신을 위한 cron 작업 또는 systemd 타이머를 설정합니다. 다음 명령으로 테스트할 수 있습니다.
    ```bash
    sudo certbot renew --dry-run
    ```

5.  **HTTPS 접속 확인**:
    웹 브라우저에서 `https://your-domain.com`으로 접속하여 웹사이트가 HTTPS로 안전하게 서비스되는지 확인합니다. HTTP로 접속 시 HTTPS로 자동 리디렉션되는지도 확인합니다.

    **주의**: Let's Encrypt는 특정 도메인에 대해 단기간에 발급할 수 있는 인증서 수에 제한(Rate Limits)이 있습니다. `kro.kr`과 같은 무료 하위 도메인 공유 서비스의 경우 이 제한에 도달하기 쉬우므로, 개인 도메인을 사용하거나 다른 도메인 공급자를 고려하는 것이 좋습니다. 오류 발생 시 메시지를 잘 확인하십시오.